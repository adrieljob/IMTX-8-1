<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TX-2</title>
    <style>
        body {
            background-color: #222;
            color: white;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100vh;
        }

        .header {
            width: 100%;
            background-color: #444;
            padding: 10px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            position: relative;
        }

        .back-button {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            cursor: pointer;
        }

        .container {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            width: 100%;
            max-width: 1200px;
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
        }

        .button-container {
            width: 200px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            background-color: #333;
            padding: 10px;
            border-radius: 10px;
            position: relative;
            height: 100%;
            box-sizing: border-box;
        }

        .button {
            padding: 10px;
            background-color: red;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 10px;
            width: 100%;
        }

        .button:hover {
            background-color: #cc0000;
        }

        .dropdown {
            position: relative;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #333;
            width: 100%;
            border-radius: 5px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        .dropdown-content a {
            display: block;
            color: white;
            padding: 10px;
            text-decoration: none;
            font-size: 16px;
        }

        .dropdown-content a:hover {
            background-color: #555;
        }

        .content-area {
            flex-grow: 1;
            background-color: #444;
            margin-left: 20px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.5);
            min-height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .status-indicator {
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            color: white;
            background-color: gray;
            display: inline-block;
            text-align: center;
        }

        .status-ethernet-connected {
            background-color: green !important;
        }

        .status-asi-connected {
            background-color: green !important;
        }

        .status-10MHz-connected {
            background-color: green !important;
        }

        .status-1PPs-connected {
            background-color: green !important;
        }

        .status-ethernet-disconnected {
            background-color: gray !important;
        }

        .status-asi-disconnected {
            background-color: gray !important;
        }

        .status-10MHz-disconnected {
            background-color: gray !important;
        }

        .status-1PPs-disconnected {
            background-color: gray !important;
        }
        .toggle-button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 20px;
      margin: 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
    }

    .hidden {
      display: none;
    }

    .status-container {
      background-color: #e6e6e6;
      color: #000;
      padding: 10px;
      margin: 15px;
      border-radius: 8px;
      width: 270px;
    }

    .status-container h3 {
      margin: 0 0 10px;
      background-color: #ccc;
      padding: 5px;
      border-radius: 4px;
    }

    .row {
      display: flex;
      justify-content: space-between;
      margin: 5px 0;
    }

    .indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background-color: red;
      display: inline-block;
    }

    .indicator.active {
      background-color: green;
    }

    .status-bar {
          display: flex;
          justify-content: space-between;
          align-items: center;
          background-color: #333;
          padding: 10px 20px;
          color: white;
          font-size: 16px;
          width: 100%;
          box-sizing: border-box;
        }

        .status-left {
          display: flex;
          align-items: center;
          gap: 20px;
        }

        .status-time {
          font-weight: bold;
        }

        .status-conn {
          padding: 5px 10px;
          border-radius: 5px;
          font-size: 14px;
          font-weight: bold;
        }

        .conn-asi.connected {
          background-color: green;
        }

        .conn-eth.connected {
          background-color: green;
        }

        .conn-asi.disconnected {
          background-color: gray;
        }

        .conn-eth.disconnected {
          background-color: gray;
        }

        .status-buttons {
          display: flex;
          gap: 10px;
        }

        .status-buttons button {
          padding: 8px 16px;
          font-size: 14px;
          border: none;
          border-radius: 5px;
          cursor: pointer;
        }

        .btn-on {
          background-color: green;
          color: white;
        }

        .btn-off {
          background-color: red;
          color: white;
        }

        .btn-back {
          background-color: #666;
          color: white;
        }

    </style>
</head>
<body>

<div class="status-bar">
    <div class="status-left">
        <span class="status-time" id="dateTime">--:--:--</span>
        <span class="status-conn conn-eth disconnected" id="connEth">ETH</span>
        <span class="status-conn conn-asi disconnected" id="connAsi">ASI</span>
    </div>
    <div class="status-buttons">
        <button class="btn-on" onclick="ligarDispositivo()">Ligar</button>
        <button class="btn-off" onclick="desligarDispositivo()">Desligar</button>
        <button class="btn-back" onclick="window.history.back()">Voltar</button>
    </div>
</div>

<div class="header">
    IMTX-8-1
</div>

<div class="container">
    <div class="button-container">
        <!-- Valores dropdown -->
        <div class="dropdown">
            <button class="button" onclick="toggleDropdown(event)">Valores</button>
            <div class="dropdown-content">
                <a href="#" onclick="fetchSnmpData('tensao36V.2')">Tensão 36V</a>
                <a href="#" onclick="fetchSnmpData('tensao24V.2')">Tensão 24V</a>
                <a href="#" onclick="fetchSnmpData('corrente.2')">Corrente</a>
                <a href="#" onclick="fetchSnmpData('frequencia.2')">Frequência</a>
                <a href="#" onclick="fetchSnmpData('temperatura.2')">Temperatura</a>
                <a href="#" onclick="fetchSnmpData('temperaturaModulo.2')">Módulo</a>
                <a href="#" onclick="fetchSnmpData('fan1.2')">FAN1 Velocidade</a>
                <a href="#" onclick="fetchSnmpData('fan2.2')">FAN2 Velocidade</a>
            </div>
        </div>

        <!-- Status buttons -->
        <button class="button" id="ethernetIndicator">Ethernet</button>
        <button class="button" id="asiIndicator">Asi</button>

        <button class="button" onclick="toggleTSStatus()">Stream</button>

        <!-- Fans dropdown -->
        <div class="dropdown">
            <button class="button" onclick="toggleDropdown(event)">Fans</button>
            <div class="dropdown-content">
                <a href="#" onclick="loadGrafana('fan1')">Velocidade fan1</a>
                <a href="#" onclick="loadGrafana('fan2')">Velocidade fan2</a>
            </div>
        </div>

        <!-- Temperatura dropdown -->
        <div class="dropdown">
            <button class="button" onclick="toggleDropdown(event)">Temperatura</button>
            <div class="dropdown-content">
                <a href="#" onclick="loadGrafana('temperatura')">Temperatura</a>
                <a href="#" onclick="loadGrafana('temperaturaModulo')">Temperatura do Módulo</a>
            </div>
        </div>

        <!-- Frequência dropdown -->
        <div class="dropdown">
            <button class="button" onclick="toggleDropdown(event)">Frequência</button>
            <div class="dropdown-content">
                <a href="#" onclick="loadGrafana('frequencia')">Frequência</a>
            </div>
        </div>
    </div>

    <!-- Stream -->
    <div id="tsStatusSection" class="hidden">
        <div class="status-container">
            <h3>Cable Present</h3>
            <div class="row"><span>Status:</span> <span id="cableStatus" class="indicator"></span></div>
            <div class="row"><span>Speed:</span> <span id="speed4">-</span></div>
            <div class="row"><span>IP Packet Rate:</span> <span id="packetRate4">-</span></div>
        </div>

        <div class="status-container">
            <h3>Transport Stream</h3>
            <div class="row"><span>Locked:</span> <span id="locked4" class="indicator"></span></div>
            <div class="row"><span>FEC D:</span> <span id="fecD4">-</span></div>
            <div class="row"><span>FEC L:</span> <span id="fecL4">-</span></div>
            <div class="row"><span>Rebuild IP Packet:</span> <span id="rebuild4">-</span></div>
            <div class="row"><span>TS Packets/sec:</span> <span id="tsPackets4">-</span></div>
            <div class="row"><span>ASI Format:</span> <span id="asi4">-</span></div>
        </div>
    </div>

    <!-- Content area for SNMP data or Grafana iframe -->
    <div class="content-area" id="content-area">
        Aqui aparecerão os dados SNMP ou gráficos do Grafana...
        <div id="snmpData"></div>
    </div>
</div>

<div>

</div>
<script>
    function fetchSnmpData(oidName) {
        const contentArea = document.getElementById('content-area');
        contentArea.textContent = 'Carregando...';

        fetch(`http://localhost:8080/snmp-data/get-snmp?oid=${oidName}`)
            .then(response => response.text())
            .then(data => {
                contentArea.textContent = `${oidName}: ${data}`;
            })
            .catch(error => {
                console.error('Erro ao obter dados SNMP:', error);
                contentArea.textContent = `Erro ao obter dados SNMP para ${oidName}`;
            });
    }

     // Toggle dropdown menu
    function toggleDropdown(event) {
        event.stopPropagation();
        const dropdown = event.target.nextElementSibling;
        document.querySelectorAll('.dropdown-content').forEach(dc => {
            if (dc !== dropdown) dc.style.display = 'none';
        });
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
    }

    // Close dropdowns on outside click
    window.addEventListener('click', () => {
        document.querySelectorAll('.dropdown-content').forEach(dc => dc.style.display = 'none');
    });

    function checkEthernetStatus() {
        fetch("http://localhost:8080/snmp-data/get-snmp?oid=ethernetCable.2")
            .then(response => response.text())
            .then(data => {
                const ethernetIndicator = document.getElementById("ethernetIndicator");
                ethernetIndicator.classList.toggle("status-ethernet-connected", parseInt(data) === 1);
                ethernetIndicator.classList.toggle("status-ethernet-disconnected", parseInt(data) === 2);
            });
    }

    function checkAsiStatus() {
        fetch("http://localhost:8080/snmp-data/get-snmp?oid=asiCable.2")
            .then(response => response.text())
            .then(data => {
                const asiIndicator = document.getElementById("asiIndicator");
                asiIndicator.classList.toggle("status-asi-connected", parseInt(data) === 1);
                asiIndicator.classList.toggle("status-asi-disconnected", parseInt(data) === 2);
            });
    }

    setInterval(checkEthernetStatus, 5000);
    checkEthernetStatus();

    setInterval(checkAsiStatus, 5000);
    checkAsiStatus();

    // Grafana URLs matching first code dashboard snapshots
    const grafanaUrls = {
        'fan1': "http://localhost:3000/d/eel66ghs5qqyoa/fan1-2?orgId=1&from=1746122163153&to=1746726963153",
        'fan2': "http://localhost:3000/d/fel66b9y5454wc/fan2-2?orgId=1&from=1746122174903&to=1746726974904",
        'temperatura': "http://localhost:3000/d/bel67nr1sdce8b/temperatura-2?orgId=1&from=1746122206726&to=1746727006726",
        'frequencia': "http://localhost:3000/d/ael68msfezuo0f/frequencia-2?orgId=1&from=1746122184562&to=1746726984562",
        'temperaturaModulo': "http://localhost:3000/d/bel69c6wfrx8ga/temperaturamodulo-2?orgId=1&from=1746122222258&to=1746727022258"
    };

    // Load Grafana dashboard into iframe in content area
    function loadGrafana(item) {
        const contentArea = document.getElementById('content-area');
        contentArea.innerHTML = ''; // Clear old content

        if (!(item in grafanaUrls)) {
            contentArea.textContent = 'Dashboard não disponível para este item.';
            return;
        }

        const iframe = document.createElement('iframe');
        iframe.className = 'grafana-frame';
        iframe.src = grafanaUrls[item];
        iframe.allowFullscreen = true;
        iframe.allow = 'fullscreen';

        // TAMANHO PERSONALIZADO
        iframe.style.width = '80%';     // ou por exemplo: '1200px'
        iframe.style.height = '370px';   // ajuste como quiser

        contentArea.appendChild(iframe);
    }

    function loadStreamTable() {
        const contentArea = document.getElementById('content-area');
        contentArea.innerHTML = '<p>Carregando dados da Stream...</p>';

        fetch('http://localhost:8080/snmp-data/transport-stream')
            .then(response => response.json())
            .then(data => {
                if (!Array.isArray(data)) {
                    contentArea.innerHTML = '<p>Nenhum dado encontrado.</p>';
                    return;
                }

                let table = '<table style="width: 100%; border-collapse: collapse; color: white;">';
                table += '<thead><tr>' +
                    '<th style="border: 1px solid #666; padding: 8px;">Program Number</th>' +
                    '<th style="border: 1px solid #666; padding: 8px;">PCR PID</th>' +
                    '<th style="border: 1px solid #666; padding: 8px;">Bitrate</th>' +
                    '<th style="border: 1px solid #666; padding: 8px;">Total Packets</th>' +
                    '<th style="border: 1px solid #666; padding: 8px;">CC Errors</th>' +
                    '<th style="border: 1px solid #666; padding: 8px;">TEI Errors</th>' +
                    '</tr></thead><tbody>';

                data.forEach(item => {
                    table += `<tr>
                        <td style="border: 1px solid #666; padding: 8px;">${item.programNumber}</td>
                        <td style="border: 1px solid #666; padding: 8px;">${item.pcrPid}</td>
                        <td style="border: 1px solid #666; padding: 8px;">${item.bitrate}</td>
                        <td style="border: 1px solid #666; padding: 8px;">${item.totalPackets}</td>
                        <td style="border: 1px solid #666; padding: 8px;">${item.ccErrors}</td>
                        <td style="border: 1px solid #666; padding: 8px;">${item.teiErrors}</td>
                    </tr>`;
                });

                table += '</tbody></table>';
                contentArea.innerHTML = table;
            })
            .catch(error => {
                console.error('Erro ao carregar a tabela de stream:', error);
                contentArea.innerHTML = '<p>Erro ao carregar dados da stream.</p>';
            });
    }

    function fetchAllSnmpDataOnLoad() {
        const oids = [
            'tensao36V.2',
            'tensao24V.2',
            'corrente.2',
            'frequencia.2',
            'temperatura.2',
            'modulo.2',
            'fan1.2',
            'fan2.2'
        ];

        oids.forEach(oid => {
            fetch(`http://localhost:8080/snmp-data/get-snmp?oid=${oid}`)
                .then(response => response.text())
                .then(data => {
                    console.log(`OID ${oid}: ${data}`);
                })
                .catch(error => {
                    console.error(`Erro ao buscar ${oid}:`, error);
                });
        });
    }

     function toggleTSStatus() {
    const section = document.getElementById("tsStatusSection");
    const btn = document.getElementById("streamButton");

    if (section.classList.contains("hidden")) {
      section.classList.remove("hidden");
      btn.textContent = "Ocultar Status TX4";
      updateTSStatus(); // carrega os dados na primeira exibição
    } else {
      section.classList.add("hidden");
      btn.textContent = "Stream";
    }
  }

  async function updateTSStatus() {
    const res = await Promise.all([
    fetch('/ts/cableStatus').then(r => r.text()),
    fetch('/ts/speed').then(r => r.text()),
    fetch('/ts/packetRate').then(r => r.text()),
    fetch('/ts/locked').then(r => r.text()),
    fetch('/ts/fecD').then(r => r.text()),
    fetch('/ts/fecL').then(r => r.text()),
    fetch('/ts/rebuild').then(r => r.text()),
    fetch('/ts/tsPackets').then(r => r.text()),
    fetch('/ts/asiFormat').then(r => r.text()),
    ]);

    const [
      cableStatus, speed, packetRate,
      locked, fecD, fecL, rebuild, tsPackets, asiFormat
    ] = res;

  document.getElementById("cableStatus").textContent = cableStatus;
  document.getElementById("speed4").textContent = speed;
  document.getElementById("packetRate4").textContent = packetRate;
  document.getElementById("locked4").textContent = locked;
  document.getElementById("fecD4").textContent = fecD;
  document.getElementById("fecL4").textContent = fecL;
  document.getElementById("rebuild4").textContent = rebuild;
  document.getElementById("tsPackets4").textContent = tsPackets;
  document.getElementById("asi4").textContent = asiFormat;
  }

   setInterval(() => {
    if (!document.getElementById("tsStatusSection").classList.contains("hidden")) {
      updateTSStatus();
    }
  }, 5000);
  function atualizarDataHora() {
      const agora = new Date();
      const dataFormatada = agora.toLocaleDateString('pt-BR');
      const horaFormatada = agora.toLocaleTimeString('pt-BR');
      document.getElementById('dateTime').textContent = `${dataFormatada} ${horaFormatada}`;
    }
// Começo
function ligarDispositivo() {
  console.log("Comando: Ligar");
  enviarComandoSNMP(1); // 1 = LIGADO
}

function desligarDispositivo() {
  console.log("Comando: Desligar");
  enviarComandoSNMP(2); // 2 = DESLIGADO
}

function enviarComandoSNMP(valor) {
  const ip = "10.10.103.103";
  const community = "private"; // Use "public" para teste de leitura
  const oid = "1.3.6.1.4.1.43768.3.1.1.10.2.8.3.1.1.2.2";

  const url = `http://localhost:8080/snmp/set?ip=${ip}&community=${community}&oid=${oid}&value=${valor}`;

  console.log("Enviando SET:", url);

  fetch(url, { method: 'POST' })
    .then(response => response.text())
    .then(data => {
      alert("Resposta: " + data);
      console.log("Resposta SNMP SET:", data);
    })
    .catch(error => {
      alert("Erro ao enviar comando SNMP: " + error);
      console.error(error);
    });
}

function voltar() {

      console.log("Voltando à tela anterior");
      window.location.href = "/menu"; // ou qualquer outra rota
    }

  function atualizarDataHora() {
    const agora = new Date();
    const dataFormatada = agora.toLocaleDateString('pt-BR');
    const horaFormatada = agora.toLocaleTimeString('pt-BR');
    document.getElementById('dateTime').textContent = `${dataFormatada} ${horaFormatada}`;
  }
  setInterval(atualizarDataHora, 1000);
  atualizarDataHora();
// Fim
    function checkEthernetStatus() {
  fetch("http://localhost:8080/snmp-data/get-snmp?oid=ethernetCable.2")
    .then(response => response.text())
    .then(data => {
      const ethernetIndicator = document.getElementById("ethernetIndicator");
      const connEth = document.getElementById("connEth");

      ethernetIndicator.classList.toggle("status-ethernet-connected", parseInt(data) === 1);
      ethernetIndicator.classList.toggle("status-ethernet-disconnected", parseInt(data) === 2);

      connEth.classList.toggle("connected", parseInt(data) === 1);
      connEth.classList.toggle("disconnected", parseInt(data) === 2);
    });
  }

  function checkAsiStatus() {
  fetch("http://localhost:8080/snmp-data/get-snmp?oid=asiCable.2")
    .then(response => response.text())
    .then(data => {
      const asiIndicator = document.getElementById("asiIndicator");
      const connAsi = document.getElementById("connAsi");

      asiIndicator.classList.toggle("status-asi-connected", parseInt(data) === 1);
      asiIndicator.classList.toggle("status-asi-disconnected", parseInt(data) === 2);

      connAsi.classList.toggle("connected", parseInt(data) === 1);
      connAsi.classList.toggle("disconnected", parseInt(data) === 2);
    });
  }

  // chamadas automáticas com intervalo
  setInterval(checkEthernetStatus, 5000);
  checkEthernetStatus();

  setInterval(checkAsiStatus, 5000);
  checkAsiStatus();

    // Atualiza status de conexão a cada 5 segundos


    window.onload = fetchAllSnmpDataOnLoad;

</script>

</body>
</html>

